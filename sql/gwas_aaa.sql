SELECT
reference_name,
start,
END,
bin,
reference_bases,
alternate_bases,
case_count,
control_count,
allele_count,
ref_count,
alt_count,
case_ref_count,
case_alt_count,
control_ref_count,
control_alt_count,
ROUND( POW(case_ref_count - (ref_count/allele_count)*case_count, 2)/((ref_count/allele_count)*case_count) + POW(control_ref_count - (ref_count/allele_count)*control_count, 2)/((ref_count/allele_count)*control_count) + POW(case_alt_count - (alt_count/allele_count)*case_count, 2)/((alt_count/allele_count)*case_count) + POW(control_alt_count - (alt_count/allele_count)*control_count, 2)/((alt_count/allele_count)*control_count), 3) AS chi_squared_score
FROM (
  SELECT
  reference_name,
  start,
  END,
  bin,
  reference_bases,
  alternate_bases,
  SUM(ref_count + alt_count) AS allele_count,
  SUM(ref_count) AS ref_count,
  SUM(alt_count) AS alt_count,
  SUM(IF(TRUE = is_case, INTEGER(ref_count + alt_count), 0)) AS case_count,
  SUM(IF(FALSE = is_case, INTEGER(ref_count + alt_count), 0)) AS control_count,
  SUM(IF(TRUE = is_case, ref_count, 0)) AS case_ref_count,
  SUM(IF(TRUE = is_case, alt_count, 0)) AS case_alt_count,
  SUM(IF(FALSE = is_case, ref_count, 0)) AS control_ref_count,
  SUM(IF(FALSE = is_case, alt_count, 0)) AS control_alt_count,
  FROM (
    SELECT
    reference_name,
    start,
    END,
    FLOOR(start/5000) AS bin,
    reference_bases,
    NTH(1, alternate_bases) WITHIN RECORD AS alternate_bases,
    # 1000 genomes data is bi-allelic so there is only ever a single alt
    SUM(0 == call.genotype) WITHIN call AS ref_count,
    SUM(1 == call.genotype) WITHIN call AS alt_count,
    call.QC,
    QC,
    call.call_set_name IN ("LP6005038-DNA_A01",
                           "LP6005038-DNA_A02",
                           "LP6005038-DNA_A03",
                           "LP6005038-DNA_A04",
                           "LP6005038-DNA_A05",
                           "LP6005038-DNA_A06",
                           "LP6005038-DNA_A07",
                           "LP6005038-DNA_A08",
                           "LP6005038-DNA_A09",
                           "LP6005038-DNA_A10",
                           "LP6005038-DNA_A11",
                           "LP6005038-DNA_A12",
                           "LP6005038-DNA_B01",
                           "LP6005038-DNA_B02",
                           "LP6005038-DNA_B03",
                           "LP6005038-DNA_B04",
                           "LP6005038-DNA_B05",
                           "LP6005038-DNA_B06",
                           "LP6005038-DNA_B08",
                           "LP6005038-DNA_B09",
                           "LP6005038-DNA_B10",
                           "LP6005038-DNA_B11",
                           "LP6005038-DNA_B12",
                           "LP6005038-DNA_C01",
                           "LP6005038-DNA_C02",
                           "LP6005038-DNA_C03",
                           "LP6005038-DNA_C04",
                           "LP6005038-DNA_C05",
                           "LP6005038-DNA_C06",
                           "LP6005038-DNA_C07",
                           "LP6005038-DNA_C08",
                           "LP6005038-DNA_C09",
                           "LP6005038-DNA_C10",
                           "LP6005038-DNA_C11",
                           "LP6005038-DNA_C12",
                           "LP6005038-DNA_D01",
                           "LP6005038-DNA_D02",
                           "LP6005038-DNA_D04",
                           "LP6005038-DNA_D05",
                           "LP6005038-DNA_D06",
                           "LP6005038-DNA_D07",
                           "LP6005038-DNA_D08",
                           "LP6005038-DNA_D09",
                           "LP6005038-DNA_D10",
                           "LP6005038-DNA_D11",
                           "LP6005038-DNA_D12",
                           "LP6005038-DNA_E01",
                           "LP6005038-DNA_E02",
                           "LP6005038-DNA_E03",
                           "LP6005038-DNA_E04",
                           "LP6005038-DNA_E05",
                           "LP6005038-DNA_E06",
                           "LP6005038-DNA_E07",
                           "LP6005038-DNA_E08",
                           "LP6005038-DNA_E09",
                           "LP6005038-DNA_E10",
                           "LP6005038-DNA_E11",
                           "LP6005038-DNA_E12",
                           "LP6005038-DNA_F01",
                           "LP6005038-DNA_F02",
                           "LP6005038-DNA_F03",
                           "LP6005038-DNA_F04",
                           "LP6005038-DNA_F05",
                           "LP6005038-DNA_F06",
                           "LP6005038-DNA_F07",
                           "LP6005038-DNA_F08",
                           "LP6005038-DNA_F09",
                           "LP6005038-DNA_F10",
                           "LP6005038-DNA_F11",
                           "LP6005038-DNA_F12",
                           "LP6005038-DNA_G01",
                           "LP6005038-DNA_G02",
                           "LP6005038-DNA_G03",
                           "LP6005038-DNA_G04",
                           "LP6005038-DNA_G05",
                           "LP6005038-DNA_G06",
                           "LP6005038-DNA_G07",
                           "LP6005038-DNA_G08",
                           "LP6005038-DNA_G09",
                           "LP6005038-DNA_G10",
                           "LP6005038-DNA_G11",
                           "LP6005038-DNA_G12",
                           "LP6005038-DNA_H01",
                           "LP6005038-DNA_H02",
                           "LP6005038-DNA_H03",
                           "LP6005038-DNA_H04",
                           "LP6005038-DNA_H05",
                           "LP6005038-DNA_H06",
                           "LP6005038-DNA_H07",
                           "LP6005038-DNA_H08",
                           "LP6005038-DNA_H09",
                           "LP6005038-DNA_H10",
                           "LP6005038-DNA_H11",
                           "LP6005038-DNA_H12",
                           "LP6005051-DNA_A01",
                           "LP6005051-DNA_A02",
                           "LP6005051-DNA_A03",
                           "LP6005051-DNA_A04",
                           "LP6005051-DNA_A05",
                           "LP6005051-DNA_A06",
                           "LP6005051-DNA_A07",
                           "LP6005051-DNA_A08",
                           "LP6005051-DNA_A09",
                           "LP6005051-DNA_A10",
                           "LP6005051-DNA_A11",
                           "LP6005051-DNA_A12",
                           "LP6005051-DNA_B01",
                           "LP6005051-DNA_B02",
                           "LP6005051-DNA_B03",
                           "LP6005051-DNA_B04",
                           "LP6005051-DNA_B05",
                           "LP6005051-DNA_B06",
                           "LP6005051-DNA_B07",
                           "LP6005051-DNA_B08",
                           "LP6005051-DNA_B09",
                           "LP6005051-DNA_B10",
                           "LP6005051-DNA_B11",
                           "LP6005051-DNA_B12",
                           "LP6005051-DNA_C01",
                           "LP6005051-DNA_C02",
                           "LP6005051-DNA_C03",
                           "LP6005051-DNA_C04",
                           "LP6005051-DNA_C05",
                           "LP6005051-DNA_C06",
                           "LP6005051-DNA_C07",
                           "LP6005051-DNA_C08",
                           "LP6005051-DNA_C09",
                           "LP6005051-DNA_C10",
                           "LP6005051-DNA_C11",
                           "LP6005051-DNA_C12",
                           "LP6005051-DNA_D01",
                           "LP6005051-DNA_D02",
                           "LP6005051-DNA_D03",
                           "LP6005051-DNA_D04",
                           "LP6005051-DNA_D05",
                           "LP6005051-DNA_D06",
                           "LP6005051-DNA_D07",
                           "LP6005051-DNA_D08",
                           "LP6005051-DNA_D10",
                           "LP6005051-DNA_D11",
                           "LP6005051-DNA_D12",
                           "LP6005051-DNA_E01",
                           "LP6005051-DNA_E02",
                           "LP6005051-DNA_E03",
                           "LP6005051-DNA_E04",
                           "LP6005051-DNA_E05",
                           "LP6005051-DNA_E06",
                           "LP6005051-DNA_E07",
                           "LP6005051-DNA_E08",
                           "LP6005051-DNA_E09",
                           "LP6005051-DNA_E10",
                           "LP6005051-DNA_E11",
                           "LP6005051-DNA_E12",
                           "LP6005051-DNA_F01",
                           "LP6005051-DNA_F02",
                           "LP6005051-DNA_F03",
                           "LP6005051-DNA_F04",
                           "LP6005051-DNA_F05",
                           "LP6005051-DNA_F06",
                           "LP6005051-DNA_F07",
                           "LP6005051-DNA_F08",
                           "LP6005051-DNA_F09",
                           "LP6005051-DNA_F10",
                           "LP6005051-DNA_F11",
                           "LP6005051-DNA_F12",
                           "LP6005051-DNA_G01",
                           "LP6005051-DNA_G02",
                           "LP6005051-DNA_G03",
                           "LP6005051-DNA_G04",
                           "LP6005051-DNA_G05",
                           "LP6005051-DNA_G06",
                           "LP6005051-DNA_G07",
                           "LP6005051-DNA_G08",
                           "LP6005051-DNA_G09",
                           "LP6005051-DNA_G10",
                           "LP6005051-DNA_G11",
                           "LP6005051-DNA_G12",
                           "LP6005051-DNA_H01",
                           "LP6005051-DNA_H02",
                           "LP6005051-DNA_H03",
                           "LP6005051-DNA_H04",
                           "LP6005051-DNA_H05",
                           "LP6005051-DNA_H06",
                           "LP6005051-DNA_H07",
                           "LP6005051-DNA_H08",
                           "LP6005051-DNA_H09",
                           "LP6005051-DNA_H10",
                           "LP6005051-DNA_H11",
                           "LP6005051-DNA_H12",
                           "LP6005144-DNA_A01",
                           "LP6005144-DNA_A03",
                           "LP6005144-DNA_A04",
                           "LP6005144-DNA_A05",
                           "LP6005144-DNA_A06",
                           "LP6005144-DNA_A07",
                           "LP6005144-DNA_A09",
                           "LP6005144-DNA_B01",
                           "LP6005144-DNA_B02",
                           "LP6005144-DNA_B03",
                           "LP6005144-DNA_B04",
                           "LP6005144-DNA_B05",
                           "LP6005144-DNA_B06",
                           "LP6005144-DNA_B07",
                           "LP6005144-DNA_C01",
                           "LP6005144-DNA_C02",
                           "LP6005144-DNA_C03",
                           "LP6005144-DNA_C04",
                           "LP6005144-DNA_C05",
                           "LP6005144-DNA_C06",
                           "LP6005144-DNA_C07",
                           "LP6005144-DNA_D01",
                           "LP6005144-DNA_D02",
                           "LP6005144-DNA_D05",
                           "LP6005144-DNA_D06",
                           "LP6005144-DNA_D07",
                           "LP6005144-DNA_E01",
                           "LP6005144-DNA_E02",
                           "LP6005144-DNA_E03",
                           "LP6005144-DNA_E05",
                           "LP6005144-DNA_E06",
                           "LP6005144-DNA_E07",
                           "LP6005144-DNA_F01",
                           "LP6005144-DNA_F02",
                           "LP6005144-DNA_F03",
                           "LP6005144-DNA_F04",
                           "LP6005144-DNA_F05",
                           "LP6005144-DNA_F06",
                           "LP6005144-DNA_F07",
                           "LP6005144-DNA_G01",
                           "LP6005144-DNA_G02",
                           "LP6005144-DNA_G03",
                           "LP6005144-DNA_G04",
                           "LP6005144-DNA_G05",
                           "LP6005144-DNA_G06",
                           "LP6005144-DNA_H01",
                           "LP6005144-DNA_H02",
                           "LP6005144-DNA_H03",
                           "LP6005144-DNA_H04",
                           "LP6005144-DNA_H05",
                           "LP6005144-DNA_H06",
                           "LP6005144-DNA_H10",
                           "LP6005243-DNA_A04",
                           "LP6005243-DNA_A05",
                           "LP6005243-DNA_A06",
                           "LP6005243-DNA_A07",
                           "LP6005243-DNA_A08",
                           "LP6005243-DNA_A11",
                           "LP6005243-DNA_B03",
                           "LP6005243-DNA_B04",
                           "LP6005243-DNA_B05",
                           "LP6005243-DNA_B06",
                           "LP6005243-DNA_B07",
                           "LP6005243-DNA_B08",
                           "LP6005243-DNA_B11",
                           "LP6005243-DNA_C04",
                           "LP6005243-DNA_C05",
                           "LP6005243-DNA_C06",
                           "LP6005243-DNA_C07",
                           "LP6005243-DNA_C08",
                           "LP6005243-DNA_C11",
                           "LP6005243-DNA_D03",
                           "LP6005243-DNA_D04",
                           "LP6005243-DNA_D05",
                           "LP6005243-DNA_D06",
                           "LP6005243-DNA_D07",
                           "LP6005243-DNA_D08",
                           "LP6005243-DNA_D10",
                           "LP6005243-DNA_D11",
                           "LP6005243-DNA_E03",
                           "LP6005243-DNA_E04",
                           "LP6005243-DNA_E05",
                           "LP6005243-DNA_E06",
                           "LP6005243-DNA_E07",
                           "LP6005243-DNA_E10",
                           "LP6005243-DNA_E11",
                           "LP6005243-DNA_F03",
                           "LP6005243-DNA_F04",
                           "LP6005243-DNA_F05",
                           "LP6005243-DNA_F06",
                           "LP6005243-DNA_F07",
                           "LP6005243-DNA_F10",
                           "LP6005243-DNA_G03",
                           "LP6005243-DNA_G04",
                           "LP6005243-DNA_G05",
                           "LP6005243-DNA_G06",
                           "LP6005243-DNA_G07",
                           "LP6005243-DNA_G10",
                           "LP6005243-DNA_H02",
                           "LP6005243-DNA_H03",
                           "LP6005243-DNA_H04",
                           "LP6005243-DNA_H05",
                           "LP6005243-DNA_H06",
                           "LP6005243-DNA_H07",
                           "LP6005243-DNA_H10",
                           "LP6005692-DNA_B02",
                           "LP6005692-DNA_C07",
                           "LP6005692-DNA_C10",
                           "LP6005692-DNA_E01",
                           "LP6005692-DNA_F06",
                           "LP6005692-DNA_G11",
                           "LP6005692-DNA_H03",
                           "LP6005692-DNA_H06",
                           "LP6005693-DNA_A02",
                           "LP6005693-DNA_A03") AS is_case,
    FROM
    [va_aaa_pilot_data.genome_calls_full_qc])
  OMIT
  call IF SOME(call.QC IS NOT NULL) 
  
  GROUP EACH BY
  reference_name,
  start,
  END,
  bin,
  reference_bases,
  alternate_bases
  HAVING 
  EVERY(QC IS NULL)
)
WHERE
# For chi-squared, expected counts must be at least 5 for each group
(ref_count/allele_count)*case_count >= 5.0
AND (ref_count/allele_count)*control_count >= 5.0
AND (alt_count/allele_count)*case_count >= 5.0
AND (alt_count/allele_count)*control_count >= 5.0 HAVING
# Chi-squared critical value for df=1, p-value=5*10^-8 is 29.71679
chi_squared_score >= 3.814
ORDER BY
chi_squared_score DESC,
start